<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Actividad â€” HUD Global + Pasos 1â€“8</title>
  <style>
    :root{
      --bg:#0b1220; --card:#121a2b; --ink:#e8f0ff; --muted:#9fb3d3;
      --red:#e05252; --orange:#f39c12; --yellow:#e6c229; --lg:#39c07f; --dg:#118a52;
      --accent:#5ab1ff; --chip-bg:#1b2640; --chip-border:#29406a; --chip-ok:#2c8e5f; --chip-bad:#b44;
      --zone:#0f1a30; --zone-border:#2b3e66; --zone-focus:#4a6ee0;
      --ok-bg:#144a2f; --ok-border:#2c8e5f; --bad-bg:#4a1414; --bad-border:#b44;
    }
    html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    main{max-width:1100px;margin:0 auto;padding:16px 16px 80px;display:grid;gap:16px}
    .card{background:var(--card);border:1px solid #203055;border-radius:16px;box-shadow:0 6px 24px rgba(0,0,0,.25);padding:16px}
    .sub{color:var(--muted)}

    /* Map */
    figure.map-wrap{text-align:center;margin:8px 0 14px}
    figure.map-wrap object{height:250px;width:auto;border-radius:12px;border:1px solid #2a3f6b;background:#0c1426}

    .hud,.step-hud{display:flex;align-items:center;gap:12px;margin:8px 0}
    .bar{flex:1;height:10px;background:#0c1426;border:1px solid #1e2c4f;border-radius:999px;overflow:hidden}
    .fill{height:100%;background:linear-gradient(90deg,#3a86ff,#66e);width:0%;transition:width .3s}
    .level{padding:2px 8px;border-radius:999px;background:#223;font-weight:700}
    .pct{min-width:50px;text-align:right}

    /* CHIPS â€” 30% bigger + orange text */
    .chip{display:inline-flex;align-items:center;justify-content:center;gap:8px;
      padding:10.4px 15.6px; /* 30% bigger */
      margin:4px;border-radius:999px;border:1px solid var(--chip-border);background:var(--chip-bg);
      cursor:pointer; font-size:1.3rem; color:var(--orange);
      user-select:none; transition:transform .15s ease, background .2s, border-color .2s}
    .chip[aria-disabled="true"]{opacity:.65;cursor:default}
    .chip.correct{background:var(--ok-bg); border-color:var(--ok-border); color:#dff7ea}
    .chip.bad{background:var(--bad-bg); border-color:var(--bad-border); color:#ffd7d7}

    /* Bank */
    .bank{display:flex;flex-wrap:wrap}

    /* Zones (Paso 3 & 4) */
    .grid-2x3{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .col{display:flex;flex-direction:column;gap:12px}
    .zone{border:1px dashed var(--zone-border);border-radius:12px;padding:10px;background:var(--zone)}
    .zone:focus, .zone[data-focus="true"]{outline:2px solid var(--zone-focus);outline-offset:2px}
    .zone-title{font-size:.95rem;color:var(--muted);margin-bottom:6px}
    .stack{display:flex;flex-direction:column;gap:6px}

    /* Jiggle animation for wrong picks */
    @keyframes jiggle { 0%,100%{transform:translateX(0)} 20%{transform:translateX(-3px)} 40%{transform:translateX(3px)} 60%{transform:translateX(-2px)} 80%{transform:translateX(2px)} }
    .jiggle{animation:jiggle .45s}

    /* Buttons & Inputs */
    button.reset{margin-top:8px;border-radius:8px;border:1px solid #2a3f6b;background:#0e1a33;color:var(--ink);padding:6px 10px;cursor:pointer}
    .input-field{background:#0e1a33;border:1px solid #2a3f6b;border-radius:8px;color:var(--ink);padding:8px;width:100%;max-width:300px}
    .input-inline{display:flex;gap:8px;align-items:center;margin-top:6px}
    .input-inline input{flex:1}

    details.standards{background:var(--card);border:1px solid #203055;border-radius:12px;padding:8px;margin-top:12px}
    summary{cursor:pointer;font-weight:600;color:var(--accent)}
    ul{margin-left:20px}
    .answer-flash{font-weight:700}

    /* Paso 8 specific */
    .drop-row{display:flex;flex-wrap:wrap;gap:8px;min-height:50px;border:1px dashed var(--zone-border);border-radius:12px;padding:10px;background:var(--zone);margin-top:6px}
    .ghost{opacity:.5}
    .trans-row{margin-top:8px; display:none}
    .toggle-trans{margin-top:6px}
  </style>
</head>
<body>
<main>
  <!-- HEADER INFO -->
  <section class="card" id="student-info">
    <label for="apellido">Apellido / Last Name:</label><br>
    <input type="text" id="apellido" class="input-field" placeholder="Escribe tu apellido aquÃ­" />

    <details class="standards">
      <summary>ğŸ¯ ACTFL 5 C Standards</summary>
      <ul>
        <li><strong>Communication:</strong> Students communicate effectively in more than one language.</li>
        <li><strong>Cultures:</strong> Students gain knowledge and understanding of other cultures.</li>
        <li><strong>Connections:</strong> Students connect with other disciplines and acquire information.</li>
        <li><strong>Comparisons:</strong> Students develop insight into the nature of language and culture.</li>
        <li><strong>Communities:</strong> Students use the language beyond the classroom.</li>
      </ul>
    </details>
  </section>

  <!-- GLOBAL HUD -->
  <section id="g-hud" class="card">
    <div class="hud">
      <div class="level" id="g-level">Starting</div>
      <div class="bar"><div class="fill" id="g-fill"></div></div>
      <div class="pct" id="g-pct">0%</div>
    </div>
  </section>

  <!-- PASO 1 -->
  <section class="card" id="paso1">
    <h2>Paso 1 â€” Â¿CuÃ¡l paÃ­s es este?</h2>
    <p class="sub">Meta: Identificar correctamente un paÃ­s hispanohablante. / Goal: Identify a Spanish-speaking country correctly.</p>
    <div class="step-hud" id="p1-hud">
      <div class="level" id="p1-level">Starting</div>
      <div class="bar"><div class="fill" id="p1-fill"></div></div>
      <div class="pct" id="p1-pct">0%</div>
    </div>
    <figure class="map-wrap">
      <object id="p1-map" data="https://upload.wikimedia.org/wikipedia/commons/8/88/Mexico_location_map.svg" type="image/svg+xml" aria-label="Mapa de MÃ©xico (Wikimedia Commons)"></object>
      <figcaption class="sub">Fuente: Wikimedia Commons â€” â€œMexico location map.svgâ€ (CC BY-SA 3.0)</figcaption>
    </figure>
    <div class="bank" id="p1-demo-chips">
      <button class="chip">Francia</button>
      <button class="chip" data-correct="true">MÃ©xico</button>
      <button class="chip">Italia</button>
    </div>
    <button class="reset" id="p1-reset">Reset Paso 1</button>
  </section>

  <!-- PASO 2 -->
  <section class="card" id="paso2">
    <h2>Paso 2 â€” Â¿QuÃ© significa <em>aprender</em>?</h2>
    <p class="sub">Meta: Reconocer el significado correcto. / Goal: Recognize the correct meaning.</p>
    <div class="step-hud" id="p2-hud">
      <div class="level" id="p2-level">Starting</div>
      <div class="bar"><div class="fill" id="p2-fill"></div></div>
      <div class="pct" id="p2-pct">0%</div>
    </div>
    <div class="bank"><button class="chip" aria-disabled="true">aprender</button></div>
    <div class="bank" id="p2-answers">
      <button class="chip" data-correct="true">to learn</button>
      <button class="chip">to learn</button>
      <button class="chip">to live</button>
      <button class="chip">to be</button>
    </div>
    <button class="reset" id="p2-reset">Reset Paso 2</button>
  </section>

  <!-- PASO 3 -->
  <section class="card" id="paso3">
    <h2>Paso 3 â€” Coloca los sujetos</h2>
    <p class="sub">Meta: Colocar todos los pronombres/sujetos en la cuadrÃ­cula 2Ã—3. / Goal: Place all subjects in the 2Ã—3 grid.</p>
    <div class="step-hud" id="p3-hud">
      <div class="level" id="p3-level">Starting</div>
      <div class="bar"><div class="fill" id="p3-fill"></div></div>
      <div class="pct" id="p3-pct">0%</div>
    </div>
    <div class="grid-2x3" id="p3-grid" aria-label="CuadrÃ­cula de sujetos">
      <div class="col" aria-label="Singular">
        <div class="zone" tabindex="0" data-zone="s1" data-accept='["yo"]'><div class="zone-title">Singular â€¢ yo</div><div class="stack" id="s1-stack"></div></div>
        <div class="zone" tabindex="0" data-zone="s2" data-accept='["tÃº"]'><div class="zone-title">Singular â€¢ tÃº</div><div class="stack" id="s2-stack"></div></div>
        <div class="zone" tabindex="0" data-zone="s3" data-accept='["Ã©l","ella","usted"]'><div class="zone-title">Singular â€¢ Ã©l / ella / usted</div><div class="stack" id="s3-stack"></div></div>
      </div>
      <div class="col" aria-label="Plural">
        <div class="zone" tabindex="0" data-zone="p1" data-accept='["nosotros","nosotras","mohammed y yo"]'><div class="zone-title">Plural â€¢ nosotros / nosotras / Mohammed y yo</div><div class="stack" id="p1-stack"></div></div>
        <div class="zone" tabindex="0" data-zone="p2" data-accept='["vosotros","vosotras"]'><div class="zone-title">Plural â€¢ vosotros / vosotras</div><div class="stack" id="p2-stack"></div></div>
        <div class="zone" tabindex="0" data-zone="p3" data-accept='["ellos","ellas","ustedes","marÃ­a y tomÃ¡s"]'><div class="zone-title">Plural â€¢ ellos / ellas / ustedes / MarÃ­a y TomÃ¡s</div><div class="stack" id="p3-stack"></div></div>
      </div>
    </div>
    <div class="bank" id="p3-bank"></div>
    <button class="reset" id="p3-reset">Reset Paso 3</button>
  </section>

  <!-- PASO 4 -->
  <section class="card" id="paso4">
    <h2>Paso 4 â€” Conjuga <em>aprender</em></h2>
    <p class="sub">Meta: Colocar cada conjugaciÃ³n en su casilla correcta (singular/plural). / Goal: Place each conjugation in the correct box.</p>
    <div class="step-hud" id="p4-hud">
      <div class="level" id="p4-level">Starting</div>
      <div class="bar"><div class="fill" id="p4-fill"></div></div>
      <div class="pct" id="p4-pct">0%</div>
    </div>
    <div class="grid-2x3" id="p4-grid" aria-label="CuadrÃ­cula de conjugaciones â€” aprender">
      <div class="col" aria-label="Singular">
        <div class="zone" tabindex="0" data-zone="hs1" data-accept='["aprendo"]'><div class="zone-title">Singular â€¢ yo</div><div class="stack" id="hs1-stack"></div></div>
        <div class="zone" tabindex="0" data-zone="hs2" data-accept='["aprendes"]'><div class="zone-title">Singular â€¢ tÃº</div><div class="stack" id="hs2-stack"></div></div>
        <div class="zone" tabindex="0" data-zone="hs3" data-accept='["aprende"]'><div class="zone-title">Singular â€¢ Ã©l / ella / usted</div><div class="stack" id="hs3-stack"></div></div>
      </div>
      <div class="col" aria-label="Plural">
        <div class="zone" tabindex="0" data-zone="hp1" data-accept='["aprendemos"]'><div class="zone-title">Plural â€¢ nosotros / nosotras</div><div class="stack" id="hp1-stack"></div></div>
        <div class="zone" tabindex="0" data-zone="hp2" data-accept='["aprendÃ©is"]'><div class="zone-title">Plural â€¢ vosotros / vosotras</div><div class="stack" id="hp2-stack"></div></div>
        <div class="zone" tabindex="0" data-zone="hp3" data-accept='["aprenden"]'><div class="zone-title">Plural â€¢ ellos / ellas / ustedes</div><div class="stack" id="hp3-stack"></div></div>
      </div>
    </div>
    <div class="bank" id="p4-bank"></div>
    <button class="reset" id="p4-reset">Reset Paso 4</button>
  </section>

  <!-- PASO 5 -->
  <section class="card" id="paso5">
    <h2>Paso 5 â€” Relaciona â€” Sujeto â†’ ConjugaciÃ³n correcta</h2>
    <p class="sub">Meta: Relacionar el sujeto con la forma correcta del presente de <em>aprender</em>. / Goal: Match the subject to the correct present form of <em>aprender</em>.</p>

    <div class="step-hud" id="p5-hud">
      <div class="level" id="p5-level">Starting</div>
      <div class="bar"><div class="fill" id="p5-fill"></div></div>
      <div class="pct" id="p5-pct">0%</div>
    </div>

    <div id="p5-prompt" style="font-size:1.4rem; font-weight:700; margin:8px 0 6px;">Sujeto: â€”</div>
    <div class="bank" id="p5-options" aria-label="Opciones de conjugaciÃ³n"></div>
    <div id="p5-stats" class="sub" style="margin-top:8px">Correctos: 0 â€” Intentos: 0 â€” PrecisiÃ³n: 0%</div>
    <button class="reset" id="p5-reset">Reset Paso 5</button>
  </section>

  <!-- PASO 6 -->
  <section class="card" id="paso6">
    <h2>Paso 6 â€” Completa la oraciÃ³n â€” ConjugaciÃ³n + idioma</h2>
    <p class="sub">Meta: Elegir la conjugaciÃ³n correcta de <em>aprender</em> para el sujeto y coincidir el <strong>idioma</strong> con su <strong>bandera</strong>. / Goal: Choose the correct conjugation of <em>aprender</em> for the subject and match the language by flag.</p>

    <div class="step-hud" id="p6-hud">
      <div class="level" id="p6-level">Starting</div>
      <div class="bar"><div class="fill" id="p6-fill"></div></div>
      <div class="pct" id="p6-pct">0%</div>
    </div>

    <div id="p6-prompt" style="font-size:1.4rem; font-weight:700; margin:8px 0 6px;">Completa: â€”</div>

    <div style="margin-top:6px; font-weight:600">1) ConjugaciÃ³n</div>
    <div class="bank" id="p6-conj"></div>

    <div style="margin-top:10px; font-weight:600">2) Bandera del idioma</div>
    <div class="bank" id="p6-flags" aria-label="Opciones de banderas"></div>

    <div id="p6-stats" class="sub" style="margin-top:8px">Correctos: 0 â€” Intentos: 0 â€” PrecisiÃ³n: 0%</div>
    <button class="reset" id="p6-reset">Reset Paso 6</button>
  </section>

  <!-- PASO 7 -->
  <section class="card" id="paso7">
    <h2>Paso 7 â€” Escribe</h2>
    <p class="sub">Meta: Escribe la forma correcta de <em>aprender</em> para el sujeto. / Goal: Type the correct present form of <em>aprender</em> for the subject.</p>

    <div class="step-hud" id="p7-hud">
      <div class="level" id="p7-level">Starting</div>
      <div class="bar"><div class="fill" id="p7-fill"></div></div>
      <div class="pct" id="p7-pct">0%</div>
    </div>

    <div id="p7-prompt" style="font-size:1.4rem; font-weight:700; margin:8px 0 6px;">Escribe: â€”</div>
    <div class="input-inline">
      <input id="p7-input" class="input-field" type="text" placeholder="Escribe aquÃ­ (ej. aprendo, aprendes...)" autocomplete="off" />
      <button id="p7-check" class="reset" type="button" style="min-width:100px">Comprobar</button>
    </div>
    <div id="p7-feedback" class="sub" style="margin-top:6px;height:20px;"></div>
    <div id="p7-stats" class="sub" style="margin-top:8px">Correctos: 0 â€” Intentos: 0 â€” PrecisiÃ³n: 0%</div>
    <button class="reset" id="p7-reset">Reset Paso 7</button>
  </section>

  <!-- PASO 8 -->
  <section class="card" id="paso8">
    <h2>Paso 8 â€” Ordena</h2>
    <p class="sub">Meta: Ordenar las fichas en espaÃ±ol para formar una oraciÃ³n correcta. / Goal: Arrange the Spanish tiles to make a correct sentence.</p>

    <div class="step-hud" id="p8-hud">
      <div class="level" id="p8-level">Starting</div>
      <div class="bar"><div class="fill" id="p8-fill"></div></div>
      <div class="pct" id="p8-pct">0%</div>
    </div>

    <div id="p8-prompt" class="sub" style="margin:6px 0 4px">Arrastra o pulsa las fichas en orden:</div>
    <div class="drop-row" id="p8-drop" aria-label="Zona para ordenar"></div>
    <div class="bank" id="p8-bank" aria-label="Banco de fichas"></div>

    <button class="reset" id="p8-undo" type="button">Deshacer Ãºltimo</button>
    <button class="reset" id="p8-reset" type="button">Reset Paso 8</button>
    <button class="reset toggle-trans" id="p8-toggle" type="button" style="display:none">Mostrar/Ocultar traducciÃ³n</button>
    <div id="p8-translation" class="trans-row sub"></div>

    <div id="p8-stats" class="sub" style="margin-top:8px">Correctos: 0 â€” Intentos: 0 â€” PrecisiÃ³n: 0%</div>
  </section>
</main>

<script>
(function(){
  // =============================
  // Speech (prefer Chrome OS EspaÃ±ol 5)
  // =============================
  let esVoice = null;
  const wantName = /chrome\s*os\s*espaÃ±ol\s*5/i;
  function pickEsVoice(){
    const voices = speechSynthesis.getVoices();
    esVoice = voices.find(v => wantName.test(v.name))
           || voices.find(v => /es-ES/i.test(v.lang))
           || voices.find(v => /^es/i.test(v.lang))
           || null;
  }
  if (typeof speechSynthesis !== 'undefined'){
    speechSynthesis.addEventListener('voiceschanged', pickEsVoice);
    pickEsVoice();
  }
  window.speakEs = (text) => {
    if (typeof speechSynthesis === 'undefined') return;
    try{
      const u = new SpeechSynthesisUtterance(String(text));
      if (esVoice) u.voice = esVoice;
      u.lang = (esVoice && esVoice.lang) || 'es-ES';
      speechSynthesis.speak(u);
    }catch(e){}
  };

  // =============================
  // Progress HUD helpers
  // =============================
  const clamp01 = (n)=> Math.max(0, Math.min(100, Number.isFinite(n)? n:0));
  const thresholds = [
    {max:59, label:'Starting', color:'var(--red)'},
    {max:72, label:'Beginning', color:'var(--orange)'},
    {max:82, label:'Approaching', color:'var(--yellow)'},
    {max:96, label:'Meeting Proficiency', color:'var(--lg)'},
    {max:100, label:'Exceeding Proficiency', color:'var(--dg)'}
  ];
  function levelFromPct(p){ for(const t of thresholds){ if (p <= t.max) return t; } return thresholds[thresholds.length-1]; }
  function paintHUD(prefix, pct){
    const fill = document.getElementById(prefix+'-fill');
    const pctEl = document.getElementById(prefix+'-pct');
    const lvlEl = document.getElementById(prefix+'-level');
    if (fill) fill.style.width = pct + '%';
    if (pctEl) pctEl.textContent = pct + '%';
    if (lvlEl){ const {label,color}=levelFromPct(pct); lvlEl.textContent=label; lvlEl.style.background=color; }
  }

  // Include up to p8 now
  window._stepPct = { p1:0, p2:0, p3:0, p4:0, p5:0, p6:0, p7:0, p8:0 };
  window.updateGlobalProgress = function(){
    const vals = Object.values(window._stepPct);
    const avg = Math.round(vals.reduce((a,b)=>a+b,0) / (vals.length || 1));
    const fill = document.getElementById('g-fill');
    const pctEl = document.getElementById('g-pct');
    const lvlEl = document.getElementById('g-level');
    if (fill) fill.style.width = avg + '%';
    if (pctEl) pctEl.textContent = avg + '%';
    if (lvlEl){ const {label,color}=levelFromPct(avg); lvlEl.textContent=label; lvlEl.style.background=color; }
  };

  window.setProgress = function(prefix, pct){
    const p = clamp01(Math.round(pct));
    window._stepPct[prefix] = p; paintHUD(prefix, p); window.updateGlobalProgress();
  };

  // Init paints
  ['g','p1','p2','p3','p4','p5','p6','p7','p8'].forEach(id=>paintHUD(id,0)); updateGlobalProgress();

  // =============================
  // PASO 1 â€” chips
  // =============================
  let p1Done = false;
  function completeP1(country, chip){
    if (p1Done) return; p1Done = true; setProgress('p1', 100);
    if (chip){ chip.classList.add('correct'); chip.closest('#p1-demo-chips').querySelectorAll('.chip').forEach(c=>{c.disabled=true; c.setAttribute('aria-disabled','true');}); }
    if (country) speakEs('Â¡Correcto! ' + country + '.');
  }
  window.finishPaso1 = completeP1;

  const p1Chips = document.getElementById('p1-demo-chips');
  p1Chips?.addEventListener('click', (e)=>{
    const btn = e.target.closest('.chip'); if (!btn || p1Done) return;
    const isCorrect = btn.dataset.correct === 'true';
    if (isCorrect){ completeP1(btn.textContent.trim(), btn); }
    else { btn.classList.add('bad','jiggle'); setTimeout(()=> btn.classList.remove('jiggle'), 500); }
  });
  document.getElementById('p1-reset')?.addEventListener('click', ()=>{
    p1Done = false; setProgress('p1', 0);
    p1Chips?.querySelectorAll('.chip').forEach(c=>{c.classList.remove('correct','bad'); c.disabled=false; c.removeAttribute('aria-disabled');});
  });

  // =============================
  // PASO 2
  // =============================
  const p2Answers = document.getElementById('p2-answers'); let p2Done = false;
  p2Answers?.addEventListener('click', (e)=>{
    const chip = e.target.closest('.chip'); if (!chip || p2Done) return;
    const label = chip.textContent.trim();
    const correct = chip.dataset.correct === 'true';
    if (correct){ chip.classList.add('correct'); speakEs(label); p2Done = true; setProgress('p2', 100);
      p2Answers.querySelectorAll('.chip').forEach(c=>{c.disabled=true; c.setAttribute('aria-disabled','true'); if (c!==chip) c.classList.remove('bad');});
    } else { chip.classList.add('bad','jiggle'); setTimeout(()=> chip.classList.remove('jiggle'), 500); }
  });
  document.getElementById('p2-reset')?.addEventListener('click', ()=>{
    p2Done = false; setProgress('p2', 0);
    p2Answers.querySelectorAll('.chip').forEach(c=>{c.classList.remove('correct','bad'); c.disabled=false; c.removeAttribute('aria-disabled');});
  });

  // Utility: shuffle array
  function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }

  // =============================
  // PASO 3 â€” drag + click-to-place
  // =============================
  const subjectsSrc = [
    'yo','tÃº','Ã©l','ella','usted','nosotros','nosotras','Mohammed y yo',
    'vosotros','vosotras','ellos','ellas','ustedes','MarÃ­a y TomÃ¡s'
  ];
  const totalP3 = subjectsSrc.length; // 14
  const bank3 = document.getElementById('p3-bank');
  const grid3 = document.getElementById('p3-grid');

  function buildBank3(){
    bank3.innerHTML='';
    const subjects = shuffle(subjectsSrc.slice());
    subjects.forEach(s=>{
      const b = document.createElement('button'); b.type='button'; b.className='chip'; b.textContent=s;
      b.draggable=true; b.setAttribute('aria-grabbed','false');
      b.addEventListener('dragstart', onDragStart);
      b.addEventListener('click', onChipClickSelect3);
      bank3.appendChild(b);
    });
  }

  let selectedChip3 = null;
  function onChipClickSelect3(e){
    const chip = e.currentTarget;
    if (selectedChip3 === chip){ chip.classList.remove('correct'); selectedChip3 = null; return; }
    if (selectedChip3) selectedChip3.classList.remove('correct');
    selectedChip3 = chip; chip.classList.add('correct'); speakEs(chip.textContent.trim());
  }

  function onDragStart(e){ const label = e.currentTarget.textContent.trim(); e.dataTransfer.setData('text/plain', label); }
  function onDragOver(e){ e.preventDefault(); e.currentTarget.dataset.focus='true'; }
  function onDragLeave(e){ e.currentTarget.dataset.focus='false'; }
  function onDrop3(e){ e.preventDefault(); e.currentTarget.dataset.focus='false'; const label=(e.dataTransfer.getData('text/plain')||'').trim(); tryPlace3(e.currentTarget, label); }

  function tryPlace3(zoneEl, label){
    const accept = JSON.parse(zoneEl.getAttribute('data-accept')||'[]');
    const norm = label.toLowerCase();
    if (accept.includes(norm)){
      speakEs(label); addToZone(zoneEl, label); removeFromBank3(label); updateP3Progress();
    } else { zoneEl.classList.add('jiggle'); setTimeout(()=>zoneEl.classList.remove('jiggle'), 500); }
  }
  function addToZone(zoneEl, label){ const stack=zoneEl.querySelector('.stack'); const item=document.createElement('div'); item.textContent=label; item.style.fontWeight='700'; stack.appendChild(item); }
  function removeFromBank3(label){
    const btn = Array.from(bank3.querySelectorAll('.chip')).find(b=>b.textContent.trim().toLowerCase()===label.toLowerCase());
    if (btn){ btn.removeEventListener('click', onChipClickSelect3); btn.remove(); if (selectedChip3===btn) selectedChip3=null; }
  }

  grid3.querySelectorAll('.zone').forEach(z=>{
    z.addEventListener('dragover', onDragOver);
    z.addEventListener('dragleave', onDragLeave);
    z.addEventListener('drop', onDrop3);
    z.addEventListener('click', ()=>{ if (!selectedChip3) return; tryPlace3(z, selectedChip3.textContent.trim()); });
    z.addEventListener('keydown', (ev)=>{ if (ev.key==='Enter'||ev.key===' '){ ev.preventDefault(); if(selectedChip3) tryPlace3(z, selectedChip3.textContent.trim()); }});
  });

  function updateP3Progress(){
    const placed = Array.from(grid3.querySelectorAll('.stack')).reduce((n,stk)=> n + stk.children.length, 0);
    const pct = Math.round((placed/totalP3)*100); setProgress('p3', pct);
  }
  function resetP3(){ grid3.querySelectorAll('.stack').forEach(s=> s.innerHTML=''); buildBank3(); selectedChip3=null; setProgress('p3', 0); }

  // =============================
  // PASO 4 â€” Conjuga aprender
  // =============================
  const conjSrc = ['aprendo','aprendes','aprende','aprendemos','aprendÃ©is','aprenden'];
  const totalP4 = conjSrc.length; // 6
  const bank4 = document.getElementById('p4-bank');
  const grid4 = document.getElementById('p4-grid');

  function buildBank4(){
    bank4.innerHTML='';
    const chips = shuffle(conjSrc.slice());
    chips.forEach(s=>{
      const b = document.createElement('button'); b.type='button'; b.className='chip'; b.textContent=s;
      b.draggable=true; b.setAttribute('aria-grabbed','false');
      b.addEventListener('dragstart', onDragStart);
      b.addEventListener('click', onChipClickSelect4);
      bank4.appendChild(b);
    });
  }
  let selectedChip4 = null;
  function onChipClickSelect4(e){
    const chip = e.currentTarget;
    if (selectedChip4 === chip){ chip.classList.remove('correct'); selectedChip4 = null; return; }
    if (selectedChip4) selectedChip4.classList.remove('correct');
    selectedChip4 = chip; chip.classList.add('correct'); speakEs(chip.textContent.trim());
  }
  function onDrop4(e){ e.preventDefault(); e.currentTarget.dataset.focus='false'; const label=(e.dataTransfer.getData('text/plain')||'').trim(); tryPlace4(e.currentTarget, label); }
  function tryPlace4(zoneEl, label){
    const accept = JSON.parse(zoneEl.getAttribute('data-accept')||'[]');
    const norm = label.toLowerCase();
    if (accept.includes(norm)){
      speakEs(label); addToZone(zoneEl, label); removeFromBank4(label); updateP4Progress();
    } else { zoneEl.classList.add('jiggle'); setTimeout(()=>zoneEl.classList.remove('jiggle'), 500); }
  }
  function removeFromBank4(label){
    const btn = Array.from(bank4.querySelectorAll('.chip')).find(b=>b.textContent.trim().toLowerCase()===label.toLowerCase());
    if (btn){ btn.removeEventListener('click', onChipClickSelect4); btn.remove(); if (selectedChip4===btn) selectedChip4=null; }
  }

  grid4.querySelectorAll('.zone').forEach(z=>{
    z.addEventListener('dragover', onDragOver);
    z.addEventListener('dragleave', onDragLeave);
    z.addEventListener('drop', onDrop4);
    z.addEventListener('click', ()=>{ if (!selectedChip4) return; tryPlace4(z, selectedChip4.textContent.trim()); });
    z.addEventListener('keydown', (ev)=>{ if (ev.key==='Enter'||ev.key===' '){ ev.preventDefault(); if(selectedChip4) tryPlace4(z, selectedChip4.textContent.trim()); }});
  });

  function updateP4Progress(){
    const placed = Array.from(grid4.querySelectorAll('.stack')).reduce((n,stk)=> n + stk.children.length, 0);
    const pct = Math.round((placed/totalP4)*100); setProgress('p4', pct);
  }
  function resetP4(){ grid4.querySelectorAll('.stack').forEach(s=> s.innerHTML=''); buildBank4(); selectedChip4=null; setProgress('p4', 0); }

  // =============================
  // PASO 5 â€” Relaciona (12/80 rule)
  // =============================
  const p5PromptEl = document.getElementById('p5-prompt');
  const p5OptionsEl = document.getElementById('p5-options');
  const p5StatsEl = document.getElementById('p5-stats');

  const conjMap = {
    'yo':'aprendo', 'tÃº':'aprendes', 'Ã©l':'aprende', 'ella':'aprende', 'usted':'aprende',
    'nosotros':'aprendemos','nosotras':'aprendemos','vosotros':'aprendÃ©is','vosotras':'aprendÃ©is',
    'ellos':'aprenden','ellas':'aprenden','ustedes':'aprenden'
  };
  const nameSubjects = [
    'JosÃ©','MarÃ­a','Ana','Luis','Carmen','Pablo','LucÃ­a','Diego','Elena','SofÃ­a',
    'Miguel','Laura','RaÃºl','Isabel','David','Sara','Javier','Paula','Encarna'
  ];
  const pairSubjects = [
    'MarÃ­a y Ana','Luis y JosÃ©','Pablo y LucÃ­a','Diego y Elena','SofÃ­a y Miguel','Laura y RaÃºl',
    'Isabel y David','Paula y Javier','Encarna y yo'
  ];
  const specialSubjects = ['Mohammed y yo'];
  const pronounPool = ['yo','tÃº','Ã©l','ella','usted','nosotros','nosotras','vosotros','vosotras','ellos','ellas','ustedes'];

  function subjectToConj(subject){
    const s = subject.trim();
    const sl = s.toLowerCase();
    if (conjMap[sl]) return conjMap[sl];
    if (sl.includes(' y yo')) return 'aprendemos';
    if (sl.includes(' y ')) return 'aprenden';
    return 'aprende';
  }
  function randomSubject(){
    const r = Math.random();
    if (r < 0.35) return pronounPool[Math.floor(Math.random()*pronounPool.length)];
    if (r < 0.75) return nameSubjects[Math.floor(Math.random()*nameSubjects.length)];
    const bucket = Math.random() < 0.5 ? pairSubjects : specialSubjects;
    return bucket[Math.floor(Math.random()*bucket.length)];
  }

  // Confetti
  function confettiBurst(){
    const container = document.body;
    const n = 120;
    for(let i=0;i<n;i++){
      const s = document.createElement('span');
      s.className='confetti-piece';
      const size = 6 + Math.random()*6;
      s.style.position='fixed';
      s.style.left = (Math.random()*100)+'vw';
      s.style.top = '-10px';
      s.style.width = size+'px';
      s.style.height = (size*0.6)+'px';
      s.style.background = `hsl(${Math.floor(Math.random()*360)},80%,60%)`;
      s.style.opacity = '0.9';
      s.style.transform = `rotate(${Math.random()*360}deg)`;
      s.style.zIndex = 9999;
      s.style.pointerEvents='none';
      const fall = 2000 + Math.random()*1500;
      const dx = (Math.random()*2-1)*200;
      s.animate([
        { transform: s.style.transform, offset: 0, top: '-10px' },
        { transform: `translate(${dx}px, 100vh) rotate(${Math.random()*720}deg)`, top: '100vh' }
      ], { duration: fall, easing:'ease-in', fill:'forwards' });
      setTimeout(()=> s.remove(), fall+100);
      container.appendChild(s);
    }
  }

  let p5Correct = 0, p5Attempts = 0, p5Done = false;
  let currentAnswer = '';

  function paintP5Stats(){
    const acc = p5Attempts ? Math.round((p5Correct/p5Attempts)*100) : 0;
    p5StatsEl.textContent = `Correctos: ${p5Correct} â€” Intentos: ${p5Attempts} â€” PrecisiÃ³n: ${acc}%`;
    const pctByCount = Math.min(1, p5Correct/12);
    const pctByAcc = Math.min(1, (p5Attempts? (p5Correct/p5Attempts) : 0)/0.80);
    const pct = Math.round(100 * Math.min(pctByCount, pctByAcc));
    setProgress('p5', pct);
  }

  function newP5Item(){
    const subj = randomSubject();
    p5PromptEl.textContent = `Sujeto: ${subj}`;
    currentAnswer = subjectToConj(subj);

    const forms = ['aprendo','aprendes','aprende','aprendemos','aprendÃ©is','aprenden'];
    const pool = forms.filter(f=>f!==currentAnswer);
    const distractors = shuffle(pool).slice(0,3);
    const options = shuffle([currentAnswer, ...distractors]);

    p5OptionsEl.innerHTML='';
    options.forEach(text=>{
      const b = document.createElement('button');
      b.type='button'; b.className='chip'; b.textContent=text;
      b.addEventListener('click', ()=> handleP5Pick(b, text));
      p5OptionsEl.appendChild(b);
    });
  }

  function handleP5Pick(btn, text){
    if (p5Done) return;
    const correct = text === currentAnswer;
    p5Attempts++;
    if (correct){
      p5Correct++; btn.classList.add('correct'); speakEs(text);
      p5OptionsEl.querySelectorAll('.chip').forEach(c=>{c.disabled=true; c.setAttribute('aria-disabled','true');});
      setTimeout(()=>{ newP5Item(); }, 550);
    } else {
      btn.classList.add('bad','jiggle'); setTimeout(()=> btn.classList.remove('jiggle'), 450);
    }
    paintP5Stats();
    const acc = p5Attempts ? (p5Correct/p5Attempts) : 0;
    if (!p5Done && p5Correct >= 12 && acc >= 0.80){
      p5Done = true; setProgress('p5', 100); confettiBurst(); speakEs('Â¡Excelente! Paso cinco completado.');
      p5OptionsEl.querySelectorAll('.chip').forEach(c=>{c.disabled=true; c.setAttribute('aria-disabled','true');});
    }
  }

  function resetP5(){ p5Correct=0; p5Attempts=0; p5Done=false; setProgress('p5', 0); paintP5Stats(); newP5Item(); }

  // =============================
  // PASO 6 â€” Completa (ConjugaciÃ³n + idioma)
  // =============================
  const p6PromptEl = document.getElementById('p6-prompt');
  const p6ConjEl = document.getElementById('p6-conj');
  const p6FlagsEl = document.getElementById('p6-flags');
  const p6StatsEl = document.getElementById('p6-stats');

  const formsAll = ['aprendo','aprendes','aprende','aprendemos','aprendÃ©is','aprenden'];
  const languages = [
    {lang:'espaÃ±ol', flags:['ğŸ‡ªğŸ‡¸','ğŸ‡²ğŸ‡½','ğŸ‡¨ğŸ‡´','ğŸ‡¦ğŸ‡·','ğŸ‡¨ğŸ‡±','ğŸ‡µğŸ‡ª','ğŸ‡¨ğŸ‡º','ğŸ‡©ğŸ‡´','ğŸ‡ºğŸ‡¾','ğŸ‡¬ğŸ‡¹','ğŸ‡­ğŸ‡³','ğŸ‡¸ğŸ‡»','ğŸ‡³ğŸ‡®','ğŸ‡¨ğŸ‡·','ğŸ‡µğŸ‡¦','ğŸ‡§â€ğŸ‡´','ğŸ‡µğŸ‡¾','ğŸ‡ªğŸ‡¨','ğŸ‡µğŸ‡·']},
    {lang:'inglÃ©s', flags:['ğŸ‡ºğŸ‡¸','ğŸ‡¬ğŸ‡§','ğŸ‡¨ğŸ‡¦','ğŸ‡¦ğŸ‡º']},
    {lang:'francÃ©s', flags:['ğŸ‡«ğŸ‡·','ğŸ‡¨ğŸ‡¦','ğŸ‡§ğŸ‡ª','ğŸ‡¨ğŸ‡­']},
    {lang:'alemÃ¡n', flags:['ğŸ‡©ğŸ‡ª','ğŸ‡¦ğŸ‡¹','ğŸ‡¨ğŸ‡­']},
    {lang:'italiano', flags:['ğŸ‡®ğŸ‡¹']},
    {lang:'portuguÃ©s', flags:['ğŸ‡µğŸ‡¹','ğŸ‡§ğŸ‡·']},
    {lang:'chino', flags:['ğŸ‡¨ğŸ‡³']},
    {lang:'japonÃ©s', flags:['ğŸ‡¯ğŸ‡µ']}
  ];

  const subjPronouns = ['yo','tÃº','Ã©l','ella','usted','nosotros','nosotras','vosotros','vosotras','ellos','ellas','ustedes'];
  const subjNamesOne = ['MarÃ­a','JosÃ©','Ana','Luis','Carmen','Pablo','LucÃ­a','Diego','Elena','SofÃ­a','Encarna'];
  const subjNamesPair = ['MarÃ­a y Ana','Luis y JosÃ©','Pablo y LucÃ­a','Encarna y yo'];

  function subjectForP6(){
    const r = Math.random();
    if (r < .34) return subjPronouns[Math.floor(Math.random()*subjPronouns.length)];
    if (r < .7) return subjNamesOne[Math.floor(Math.random()*subjNamesOne.length)];
    if (r < .9) return subjNamesPair[Math.floor(Math.random()*subjNamesPair.length)];
    return 'Mohammed y yo';
  }
  function conjForSubject(s){
    const lo = s.toLowerCase();
    if (lo==='yo') return 'aprendo';
    if (lo==='tÃº') return 'aprendes';
    if (['Ã©l','ella','usted'].includes(lo)) return 'aprende';
    if (lo.includes(' y yo') || ['nosotros','nosotras'].includes(lo)) return 'aprendemos';
    if (['vosotros','vosotras'].includes(lo)) return 'aprendÃ©is';
    if (lo.includes(' y ')) return 'aprenden';
    return 'aprende';
  }

  function pickLanguage(){ return languages[Math.floor(Math.random()*languages.length)]; }

  let p6Correct=0, p6Attempts=0, p6Done=false;
  let p6NeededConj='', p6FlagCorrect='';
  let p6PickedConj=null, p6PickedFlag=null;

  function paintP6Stats(){
    const acc = p6Attempts? Math.round((p6Correct/p6Attempts)*100) : 0;
    p6StatsEl.textContent = `Correctos: ${p6Correct} â€” Intentos: ${p6Attempts} â€” PrecisiÃ³n: ${acc}%`;
    const pctByCnt = Math.min(1, p6Correct/10);
    const pctByAcc = Math.min(1, (p6Attempts? (p6Correct/p6Attempts) : 0)/0.80);
    setProgress('p6', Math.round(100*Math.min(pctByCnt,pctByAcc)));
  }

  function newP6Item(){
    p6PickedConj=null; p6PickedFlag=null;
    const subj = subjectForP6();
    const L = pickLanguage();
    const lang = L.lang; const flags = L.flags;
    const correctFlag = flags[Math.floor(Math.random()*flags.length)];
    p6FlagCorrect = correctFlag;
    p6NeededConj = conjForSubject(subj);

    p6PromptEl.textContent = `Completa: ${subj} ____ ${lang}.`;

    const pool = formsAll.filter(f=>f!==p6NeededConj);
    const distractors = shuffle(pool).slice(0,3);
    const conjOptions = shuffle([p6NeededConj, ...distractors]);
    p6ConjEl.innerHTML='';
    conjOptions.forEach(txt=>{
      const b=document.createElement('button'); b.type='button'; b.className='chip'; b.textContent=txt;
      b.addEventListener('click', ()=> handlePickConj(b, txt)); p6ConjEl.appendChild(b);
    });

    const otherFlags = languages.flatMap(x=>x.flags).filter(f=>!flags.includes(f));
    const flagDistractors = shuffle(otherFlags).slice(0,3);
    const flagOptions = shuffle([correctFlag, ...flagDistractors]);
    p6FlagsEl.innerHTML='';
    flagOptions.forEach(flag=>{
      const b=document.createElement('button'); b.type='button'; b.className='chip'; b.textContent=flag;
      b.setAttribute('aria-label', `Bandera ${flag}`);
      b.addEventListener('click', ()=> handlePickFlag(b, flag)); p6FlagsEl.appendChild(b);
    });
  }

  function handlePickConj(btn, txt){
    const ok = txt===p6NeededConj;
    if (ok){ if (p6PickedConj) p6PickedConj.classList.remove('correct'); p6PickedConj = btn; btn.classList.add('correct'); speakEs(txt); }
    else { btn.classList.add('bad','jiggle'); setTimeout(()=>btn.classList.remove('jiggle'),450); }
    checkP6Both();
  }
  function handlePickFlag(btn, flag){
    const ok = flag===p6FlagCorrect;
    if (ok){ if (p6PickedFlag) p6PickedFlag.classList.remove('correct'); p6PickedFlag = btn; btn.classList.add('correct'); speakEs('bien'); }
    else { btn.classList.add('bad','jiggle'); setTimeout(()=>btn.classList.remove('jiggle'),450); }
    checkP6Both();
  }
  function lockP6(){
    p6ConjEl.querySelectorAll('.chip').forEach(c=>{c.disabled=true; c.setAttribute('aria-disabled','true');});
    p6FlagsEl.querySelectorAll('.chip').forEach(c=>{c.disabled=true; c.setAttribute('aria-disabled','true');});
  }
  function checkP6Both(){
    if (p6PickedConj && p6PickedFlag){
      p6Attempts++;
      const isCorrect = (p6PickedConj.textContent.trim()===p6NeededConj) && (p6PickedFlag.textContent.trim()===p6FlagCorrect);
      if (isCorrect){
        p6Correct++; lockP6();
        setTimeout(()=>{ newP6Item(); }, 600);
      }
      paintP6Stats();
      if (!p6Done){
        const acc = p6Attempts? (p6Correct/p6Attempts) : 0;
        if (p6Correct>=10 && acc>=0.80){ p6Done=true; setProgress('p6', 100); confettiBurst(); speakEs('Â¡Muy bien! Paso seis completado.'); lockP6(); }
      }
    }
  }
  function resetP6(){ p6Correct=0; p6Attempts=0; p6Done=false; setProgress('p6',0); paintP6Stats(); newP6Item(); }

  // =============================
  // PASO 7 â€” Escribe (12/80 rule, accent-accurate)
  // =============================
  const p7PromptEl = document.getElementById('p7-prompt');
  const p7Input = document.getElementById('p7-input');
  const p7Check = document.getElementById('p7-check');
  const p7Feedback = document.getElementById('p7-feedback');
  const p7StatsEl = document.getElementById('p7-stats');

  let p7Correct=0, p7Attempts=0, p7Done=false;
  let p7Answer=''; let p7Subject='';

  function paintP7Stats(){
    const acc = p7Attempts? Math.round((p7Correct/p7Attempts)*100) : 0;
    p7StatsEl.textContent = `Correctos: ${p7Correct} â€” Intentos: ${p7Attempts} â€” PrecisiÃ³n: ${acc}%`;
    const pctByCount = Math.min(1, p7Correct/12);
    const pctByAcc = Math.min(1, (p7Attempts? (p7Correct/p7Attempts) : 0)/0.80);
    setProgress('p7', Math.round(100*Math.min(pctByCount, pctByAcc)));
  }

  function newP7Item(){
    p7Input.value=''; p7Input.disabled=false; p7Input.focus();
    p7Feedback.textContent='';
    p7Subject = randomSubject();
    p7Answer = subjectToConj(p7Subject); // exact accent-sensitive answer
    p7PromptEl.textContent = `Escribe: ${p7Subject} ____ espaÃ±ol.`;
  }

  function flashAnswerTemp(correctText){
    p7Input.value = correctText; // shows accents; user must replicate next try
    p7Input.classList.add('answer-flash');
    setTimeout(()=>{
      p7Input.classList.remove('answer-flash');
      p7Input.value='';
      p7Input.focus();
    }, 4000);
  }

  function handleP7Check(){
    if (p7Done) return;
    const val = (p7Input.value || '').trim();
    if (!val) return;
    p7Attempts++;
    // accent-sensitive: require exact string (case-insensitive but diacritics must match)
    if (val.toLocaleLowerCase('es-ES') === p7Answer.toLocaleLowerCase('es-ES')){
      p7Correct++; speakEs(val);
      newP7Item();
    } else {
      flashAnswerTemp(p7Answer);
    }
    paintP7Stats();
    const acc = p7Attempts? (p7Correct/p7Attempts) : 0;
    if (!p7Done && p7Correct>=12 && acc>=0.80){
      p7Done = true; setProgress('p7', 100); confettiBurst(); speakEs('Â¡Excelente! Paso siete completado.');
      p7Input.disabled=true;
    }
  }

  p7Check?.addEventListener('click', handleP7Check);
  p7Input?.addEventListener('keydown', (e)=>{ if (e.key==='Enter'){ handleP7Check(); } });

  function resetP7(){ p7Correct=0; p7Attempts=0; p7Done=false; setProgress('p7',0); paintP7Stats(); newP7Item(); }

  // =============================
  // PASO 8 â€” Ordena (12/80 rule)
  // =============================
  const p8Drop = document.getElementById('p8-drop');
  const p8Bank = document.getElementById('p8-bank');
  const p8StatsEl = document.getElementById('p8-stats');
  const p8TransEl = document.getElementById('p8-translation');
  const p8Toggle = document.getElementById('p8-toggle');
  const p8Undo = document.getElementById('p8-undo');

  let p8Correct=0, p8Attempts=0, p8Done=false;
  let p8Current = null; // {tokens:[], english:'', full:''}

  const sentencePool = [
    {full:'Yo aprendo espaÃ±ol.', tokens:['Yo','aprendo','espaÃ±ol.'], english:'I speak Spanish.'},
    {full:'TÃº aprendes inglÃ©s.', tokens:['TÃº','aprendes','inglÃ©s.'], english:'You speak English.'},
    {full:'Ã‰l aprende francÃ©s.', tokens:['Ã‰l','aprende','francÃ©s.'], english:'He speaks French.'},
    {full:'Ella aprende alemÃ¡n.', tokens:['Ella','aprende','alemÃ¡n.'], english:'She speaks German.'},
    {full:'Usted aprende italiano.', tokens:['Usted','aprende','italiano.'], english:'You (formal) speak Italian.'},
    {full:'Nosotros aprendemos espaÃ±ol.', tokens:['Nosotros','aprendemos','espaÃ±ol.'], english:'We speak Spanish.'},
    {full:'Nosotras aprendemos espaÃ±ol.', tokens:['Nosotras','aprendemos','espaÃ±ol.'], english:'We (fem.) speak Spanish.'},
    {full:'Vosotros aprendÃ©is espaÃ±ol.', tokens:['Vosotros','aprendÃ©is','espaÃ±ol.'], english:'You all (Spain) speak Spanish.'},
    {full:'Vosotras aprendÃ©is espaÃ±ol.', tokens:['Vosotras','aprendÃ©is','espaÃ±ol.'], english:'You all (fem., Spain) speak Spanish.'},
    {full:'Ellos aprenden portuguÃ©s.', tokens:['Ellos','aprenden','portuguÃ©s.'], english:'They speak Portuguese.'},
    {full:'Ellas aprenden japonÃ©s.', tokens:['Ellas','aprenden','japonÃ©s.'], english:'They (fem.) speak Japanese.'},
    {full:'Ustedes aprenden chino.', tokens:['Ustedes','aprenden','chino.'], english:'You all speak Chinese.'},
    {full:'MarÃ­a aprende espaÃ±ol.', tokens:['MarÃ­a','aprende','espaÃ±ol.'], english:'MarÃ­a speaks Spanish.'},
    {full:'JosÃ© aprende inglÃ©s.', tokens:['JosÃ©','aprende','inglÃ©s.'], english:'JosÃ© speaks English.'},
    {full:'MarÃ­a y Ana aprenden francÃ©s.', tokens:['MarÃ­a','y','Ana','aprenden','francÃ©s.'], english:'MarÃ­a and Ana speak French.'},
    {full:'Encarna y yo aprendemos espaÃ±ol.', tokens:['Encarna','y','yo','aprendemos','espaÃ±ol.'], english:'Encarna and I speak Spanish.'},
    {full:'Pablo y LucÃ­a aprenden alemÃ¡n.', tokens:['Pablo','y','LucÃ­a','aprenden','alemÃ¡n.'], english:'Pablo and LucÃ­a speak German.'},
    {full:'Luis y JosÃ© aprenden italiano.', tokens:['Luis','y','JosÃ©','aprenden','italiano.'], english:'Luis and JosÃ© speak Italian.'}
  ];

  function paintP8Stats(){
    const acc = p8Attempts? Math.round((p8Correct/p8Attempts)*100) : 0;
    p8StatsEl.textContent = `Correctos: ${p8Correct} â€” Intentos: ${p8Attempts} â€” PrecisiÃ³n: ${acc}%`;
    const pctByCount = Math.min(1, p8Correct/12);
    const pctByAcc = Math.min(1, (p8Attempts? (p8Correct/p8Attempts) : 0)/0.80);
    setProgress('p8', Math.round(100*Math.min(pctByCount, pctByAcc)));
  }

  function newP8Item(){
    p8Drop.innerHTML='';
    p8Bank.innerHTML='';
    p8TransEl.style.display='none';
    p8Toggle.style.display='none';
    p8TransEl.textContent='';
    p8Current = sentencePool[Math.floor(Math.random()*sentencePool.length)];
    const shuffled = shuffle(p8Current.tokens.slice());
    shuffled.forEach(tok => {
      const b = document.createElement('button');
      b.type='button'; b.className='chip';
      b.textContent = tok;
      b.draggable = true;
      b.addEventListener('dragstart', e=>{ e.dataTransfer.setData('text/plain', tok); e.dataTransfer.effectAllowed='move'; b.classList.add('ghost'); });
      b.addEventListener('dragend', ()=> b.classList.remove('ghost'));
      b.addEventListener('click', ()=> moveTokenToDrop(b));
      p8Bank.appendChild(b);
    });
  }

  function moveTokenToDrop(btn){
    // Move the actual node into the drop zone
    p8Drop.appendChild(btn);
    checkP8Order();
  }

  // Drag & drop handlers for drop zone
  p8Drop.addEventListener('dragover', e=>{ e.preventDefault(); });
  p8Drop.addEventListener('drop', e=>{
    e.preventDefault();
    const tok = e.dataTransfer.getData('text/plain');
    const btn = Array.from(p8Bank.querySelectorAll('.chip')).find(x => x.textContent === tok);
    if (btn){ moveTokenToDrop(btn); }
  });

  function checkP8Order(){
    const built = Array.from(p8Drop.querySelectorAll('.chip')).map(b=>b.textContent);
    // Only check when lengths match
    if (!p8Current || built.length !== p8Current.tokens.length) return;
    p8Attempts++;
    const ok = built.join(' ') === p8Current.tokens.join(' ');
    if (ok){
      p8Correct++;
      // lock chips, reveal translation, speak sentence, next item
      p8Drop.querySelectorAll('.chip').forEach(c=>{ c.disabled=true; c.setAttribute('aria-disabled','true'); c.classList.add('correct'); });
      speakEs(p8Current.full);
      p8TransEl.textContent = p8Current.english;
      p8TransEl.style.display = 'block';
      p8Toggle.style.display = 'inline-block';
      p8Toggle.onclick = () => { p8TransEl.style.display = (p8TransEl.style.display==='none' ? 'block' : 'none'); };
      setTimeout(()=> newP8Item(), 900);
    } else {
      // wrong: jiggle entire drop, then return tokens to bank for retry
      p8Drop.classList.add('jiggle');
      setTimeout(()=>{
        p8Drop.classList.remove('jiggle');
        // send all back
        while(p8Drop.firstChild){ p8Bank.appendChild(p8Drop.firstChild); }
      }, 500);
    }
    paintP8Stats();
    const acc = p8Attempts? (p8Correct/p8Attempts) : 0;
    if (!p8Done && p8Correct>=12 && acc>=0.80){
      p8Done = true; setProgress('p8', 100); confettiBurst(); speakEs('Â¡Excelente! Paso ocho completado.');
    }
  }

  p8Undo.addEventListener('click', ()=>{
    const last = p8Drop.lastElementChild;
    if (last){ p8Bank.appendChild(last); }
  });

  function resetP8(){ p8Correct=0; p8Attempts=0; p8Done=false; setProgress('p8',0); paintP8Stats(); newP8Item(); }

  // === Initialize once DOM is ready ===
  window.addEventListener('DOMContentLoaded', () => {
    buildBank3();
    buildBank4();
    paintP5Stats();
    newP5Item();

    paintP6Stats();
    newP6Item();

    paintP7Stats();
    newP7Item();

    paintP8Stats();
    newP8Item();

    document.getElementById('p3-reset')?.addEventListener('click', resetP3);
    document.getElementById('p4-reset')?.addEventListener('click', resetP4);
    document.getElementById('p5-reset')?.addEventListener('click', resetP5);
    document.getElementById('p6-reset')?.addEventListener('click', resetP6);
    document.getElementById('p7-reset')?.addEventListener('click', resetP7);
    document.getElementById('p8-reset')?.addEventListener('click', resetP8);
  });
})();
</script>
</body>
</html>
